events {}

http {
    server {
        listen 80; 
        
        # Chỉ cho Nginx cách tìm các service khác (DNS của Docker)
        resolver 127.0.0.11;

        # --- XOÁ TẤT CẢ CẤU HÌNH CORS TẠI ĐÂY ---
        # Chúng ta sẽ để cho các service backend tự xử lý

        # --- ĐIỀU HƯỚNG CHO USER SERVICE ---
        
        location /api/auth {
            # ⭐️ XOÁ: Tất cả 'add_header', 'proxy_hide_header' và 'if (OPTIONS)'
            
            rewrite /api/auth(.*) /api/v1/auth$1 break;
            proxy_pass http://user-service:3000; 
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/users {
            # ⭐️ XOÁ: Tất cả 'add_header', 'proxy_hide_header' và 'if (OPTIONS)'

            rewrite /api/users(.*) /api/v1/users$1 break;
            proxy_pass http://user-service:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- ĐIỀU HƯỚNG CHO PRODUCT SERVICE ---

        location /api/products {
            # ⭐️ XOÁ: Tất cả 'add_header', 'proxy_hide_header' và 'if (OPTIONS)'

            rewrite /api/products(.*) /api/v1/products$1 break;
            proxy_pass http://product-service:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        location /api/restaurants {
            # ⭐️ XOÁ: Tất cả 'add_header', 'proxy_hide_header' và 'if (OPTIONS)'

            rewrite /api/restaurants(.*) /api/v1/restaurants$1 break;
            proxy_pass http://product-service:3002;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
        
        # --- ĐIỀU HƯỚNG CHO ORDER SERVICE ---

        location /api/orders {
            # ⭐️ XOÁ: Tất cả 'add_header', 'proxy_hide_header' và 'if (OPTIONS)'
            
            rewrite /api/orders(.*) /order$1 break;
            proxy_pass http://order-service:8082;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}