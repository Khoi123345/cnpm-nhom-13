name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Job 1: Build vÃ  test Frontend
  frontend-build:
    name: Build Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: foodfast-delivery/frontend/package-lock.json

      - name: Install dependencies
        working-directory: ./foodfast-delivery/frontend
        run: npm ci --legacy-peer-deps

      - name: Lint check
        working-directory: ./foodfast-delivery/frontend
        run: npm run lint || echo "Lint warnings found"
        continue-on-error: true

      - name: Build frontend
        working-directory: ./foodfast-delivery/frontend
        run: npm run build
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8080

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: foodfast-delivery/frontend/.next
          retention-days: 1

  # Job 2: Build vÃ  test User Service
  user-service-build:
    name: Build User Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: foodfast-delivery/services/user-service/package-lock.json

      - name: Install dependencies
        working-directory: ./foodfast-delivery/services/user-service
        run: npm ci --legacy-peer-deps

      - name: Syntax check with Node
        working-directory: ./foodfast-delivery/services/user-service
        run: |
          for file in $(find src -name '*.js'); do
            node --check $file || exit 1
          done

      - name: Run tests (if available)
        working-directory: ./foodfast-delivery/services/user-service
        run: npm test || echo "No tests configured"
        continue-on-error: true

  # Job 3: Build Product Service
  product-service-build:
    name: Build Product Service
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: foodfast-delivery/services/product-service/package-lock.json

      - name: Install dependencies
        working-directory: ./foodfast-delivery/services/product-service
        run: npm ci

      - name: Syntax check with Node
        working-directory: ./foodfast-delivery/services/product-service
        run: |
          for file in $(find src -name '*.js'); do
            node --check $file || exit 1
          done

      - name: Run tests (if available)
        working-directory: ./foodfast-delivery/services/product-service
        run: npm test || echo "No tests configured"
        continue-on-error: true

  # Job 4: Build Java services (Order, Payment, Drone)
  java-services-build:
    name: Build Java Services
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service: [order-service, payment-service, drone-service]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'maven'

      - name: Compile check (syntax validation)
        working-directory: ./foodfast-delivery/services/${{ matrix.service }}
        run: mvn clean compile

      - name: Build with Maven
        working-directory: ./foodfast-delivery/services/${{ matrix.service }}
        run: mvn package -DskipTests

      - name: Run tests
        working-directory: ./foodfast-delivery/services/${{ matrix.service }}
        run: mvn test || echo "Tests failed or not configured"
        continue-on-error: true

      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.service }}-jar
          path: foodfast-delivery/services/${{ matrix.service }}/target/*.jar
          retention-days: 1

  # Job 5: Docker Build (chá»‰ cháº¡y khi merge vÃ o main)
  docker-build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [frontend-build, user-service-build, product-service-build, java-services-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Frontend Docker Image
        run: |
          docker build -t foodfast-frontend:${{ github.sha }} ./foodfast-delivery/frontend

      - name: Build User Service Docker Image
        run: |
          docker build -t foodfast-user-service:${{ github.sha }} ./foodfast-delivery/services/user-service

      - name: Build Product Service Docker Image
        run: |
          docker build -t foodfast-product-service:${{ github.sha }} ./foodfast-delivery/services/product-service

      - name: Build Order Service Docker Image
        run: |
          docker build -t foodfast-order-service:${{ github.sha }} ./foodfast-delivery/services/order-service

      - name: Build Payment Service Docker Image
        run: |
          docker build -t foodfast-payment-service:${{ github.sha }} ./foodfast-delivery/services/payment-service

      - name: Build Drone Service Docker Image
        run: |
          docker build -t foodfast-drone-service:${{ github.sha }} ./foodfast-delivery/services/drone-service

  # Job 6: Auto Deploy to EC2
  deploy-to-ec2:
    name: Deploy to EC2
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/ec2_key.pem
          chmod 600 ~/.ssh/ec2_key.pem
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/ec2_key.pem -o StrictHostKeyChecking=no ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e
            echo "ðŸ“¦ Starting deployment..."
            
            # Navigate to project directory
            cd ~/cnpm-nhom-13/foodfast-delivery
            
            # Pull latest code
            echo "â¬‡ï¸ Pulling latest code from GitHub..."
            git pull origin main
            
            # Stop running containers
            echo "ðŸ›‘ Stopping containers..."
            docker compose down
            
            # Remove old images to free up space
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af || true
            
            # Rebuild and start services
            echo "ðŸ”¨ Building and starting services..."
            docker compose up -d --build
            
            # Wait for services to be ready
            echo "â³ Waiting for services to start..."
            sleep 30
            
            # Check services status
            echo "âœ… Checking services status..."
            docker compose ps
            
            # Test API Gateway
            echo "ðŸ” Testing API Gateway..."
            curl -f http://localhost:8080/health || echo "âš ï¸ API Gateway health check failed"
            
            echo "ðŸŽ‰ Deployment completed successfully!"
          EOF

      - name: Verify Deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 10
          
          # Test public endpoints
          curl -f http://${EC2_HOST}:3000 || echo "âš ï¸ Frontend not responding"
          curl -f http://${EC2_HOST}:8080 || echo "âš ï¸ API Gateway not responding"
          
          echo "âœ… Deployment verification completed"

      - name: Rollback on Failure
        if: failure()
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
        run: |
          ssh -i ~/.ssh/ec2_key.pem ${EC2_USER}@${EC2_HOST} << 'EOF'
            echo "âŒ Deployment failed, attempting rollback..."
            cd ~/cnpm-nhom-13/foodfast-delivery
            
            # Rollback to previous commit
            git reset --hard HEAD~1
            
            # Restart services
            docker compose down
            docker compose up -d --build
            
            echo "ðŸ”„ Rollback completed"
          EOF

      - name: Deployment Summary
        if: always()
        run: |
          echo "ðŸ“Š Deployment Summary"
          echo "===================="
          echo "Commit: ${{ github.sha }}"
          echo "Branch: ${{ github.ref }}"
          echo "Author: ${{ github.actor }}"
          echo "Status: ${{ job.status }}"
